@startuml Scenario - Create Lending

skinparam backgroundColor #FEFEFE
skinparam sequenceMessageAlign center

title Scenario: Create New Lending (Sequence Diagram)

actor "Librarian" as Librarian
participant "<<system>>\nLibrary System\nUI" as UI
participant "<<component>>\nLending\nController" as Controller
participant "<<component>>\nLending\nService" as Service
participant "<<component>>\nLending\nRepository" as Repository
participant "<<component>>\nBook\nRepository" as BookRepo
participant "<<component>>\nReader\nRepository" as ReaderRepo
database "<<database>>\nH2 Database" as DB

' Lollipop interfaces
interface "REST API" as IREST
interface "Service API" as ISvc
interface "Repository API" as IRepo
interface "JDBC API" as IJDBC

Controller - IREST
Service - ISvc
Repository - IRepo
DB - IJDBC

Librarian -> UI : 1: create lending
activate UI

UI -> IREST : 1.1: POST /api/lendings
activate IREST
IREST -> Controller : 1.1.1: createLending(dto)
activate Controller

Controller -> ISvc : 1.2: create(lendingDTO)
activate ISvc
ISvc -> Service : 1.2.1: validate & process
activate Service

Service -> BookRepo : 1.3: findByIsbn(isbn)
activate BookRepo
BookRepo -> DB : 1.3.1: SELECT * FROM book
activate DB
DB --> BookRepo : 1.3.2: book data
deactivate DB
BookRepo --> Service : 1.3.3: Book entity
deactivate BookRepo

Service -> ReaderRepo : 1.4: findByNumber(readerNumber)
activate ReaderRepo
ReaderRepo -> DB : 1.4.1: SELECT * FROM reader
activate DB
DB --> ReaderRepo : 1.4.2: reader data
deactivate DB
ReaderRepo --> Service : 1.4.3: Reader entity
deactivate ReaderRepo

Service -> Service : 1.5: create Lending entity\ncalculate limit date

Service -> IRepo : 1.6: save(lending)
activate IRepo
IRepo -> Repository : 1.6.1: persist
activate Repository
Repository -> IJDBC : 1.6.2: INSERT INTO lending
activate IJDBC
IJDBC -> DB : 1.6.3: execute insert
activate DB
DB --> IJDBC : 1.6.4: lending saved
deactivate DB
IJDBC --> Repository : 1.6.5: success
deactivate IJDBC
Repository --> IRepo : 1.6.6: Lending entity
deactivate Repository
IRepo --> Service : 1.6.7: saved lending
deactivate IRepo

Service --> ISvc : 1.7: LendingDTO
deactivate Service
ISvc --> Controller : 1.7.1: result
deactivate ISvc

Controller --> IREST : 1.8: HTTP 201 Created
deactivate Controller
IREST --> UI : 1.8.1: lending created
deactivate IREST

UI --> Librarian : 1.9: display confirmation
deactivate UI

note right of Service
  <b>Business Rules Applied:</b>
  - Verify book availability
  - Check reader eligibility
  - Calculate limit date (14 days)
  - Set fine rate per day
end note

@enduml
